# Added to trigger GitHub Actions

# Human-readable name to identify this pipeline
name: CI/CD Pipeline for User Service

# Every time code is pushed to the 'main' branch, The workflow automatically runs (triggers pipeline)
on:
  push:
    branches:
      - main

# Having one job: 'build', As A workflow can have multiple jobs.
jobs:
  build:
    runs-on: ubuntu-latest  # runner VM
    steps:  # Each step runs top to bottom.
      # Step 1: Checkout source code from the repository
      - name: Checkout code
        uses: actions/checkout@v3   # Clones your GitHub repository into the runner VM

      # Step 2: Set up JDK 21 environment
      - name: Set up JDK 21         # Maven needs Java
        uses: actions/setup-java@v3
        with:
          java-version: '21'        # Installs Java 21
          distribution: 'corretto'  # Uses Amazon Corretto JDK
          cache: maven              # Caches ~/.m2 dependencies As Caching avoids downloading dependencies

      # Step 3: Build the application using Maven (skip tests)
      - name: Build with Maven
        run: mvn clean package -DskipTests  # deletes target/ | compiles code + builds JAR | skips unit tests

      # Step 4: Login to Docker Hub using credentials stored in GitHub Secrets
      - name: Login to Docker Hub  # Needed to push images to Docker Hub
        run: echo "${{ secrets.DOCKER_ACCESS_TOKEN }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      # Step 5: Build Docker image and push it to Docker Hub
      - name: Build and push Docker image
        working-directory: "user-service"
        run: |
          # Build Docker Image Using Dockerfile from directory(.)
               docker build -t sopankute87/user-service:latest .
          # Uploads image to Docker Hub
               docker push sopankute87/user-service:latest

      # Step 6: Deploy the application to the VPS server
#      - name: Deploy to VPS
#        uses: appleboy/ssh-action@master  # Opens SSH connection to your VPS | Executes commands remotely
#        with:
#          host: ${{ secrets.VPS_HOST }}
#          username: ${{ secrets.VPS_USERNAME }}
#          key: ${{ secrets.VPS_SSH_KEY }}
#          script: |
#          # Pull the latest version Docker image from Docker Hub
#            docker pull sopankute87/user-service:latest
#
#          # Stop and remove the old container if it exists, Prevents port conflicts.
#            docker rm -f user-service || echo "No container named user-service found."
#
#          # Remove unused dangling Docker images to free space on VPS
#            docker images -f "dangling=true" -q | xargs --no-run-if-empty docker rmi
#
#          # Run a new container using the latest image
#            docker run -d \
#            -p 8081:8081 \                      # Map host â†’ container port
#            --env-file /root/sopankute/.env \    # Load environment variables
#            --name user-service \               # Container name
#            sopankute87/user-service:latest


